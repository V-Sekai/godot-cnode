name: Build GDExtension

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - "main"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Setup clang-format
        shell: bash
        run: |
          python -m pip install clang-format
      - name: Run clang-format
        shell: bash
        run: |
          clang-format --style=file:.clang-format src/** --dry-run --Werror

  build_ci:
    needs: [lint]
    if: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: { platform: linux, arch: x86_64, os: ubuntu-latest }
            target-type: template_release
            float-precision: single
          - target: { platform: linux, arch: x86_64, os: ubuntu-latest }
            target-type: template_release
            float-precision: double
          - target: { platform: windows, arch: x86_64, os: windows-latest }
            target-type: template_release
            float-precision: single
          - target: { platform: macos, arch: universal, os: macos-latest }
            target-type: template_release
            float-precision: single
          - target: { platform: android, arch: arm64, os: ubuntu-latest }
            target-type: template_release
            float-precision: single
    runs-on: ${{ matrix.target.os }}
    steps:
      # Clone this repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      # Setup Erlang/OTP for erl_interface (needed for godot-cnode)
      # Note: erl_interface is built from source, but we install Erlang for system libraries
      - name: Setup Erlang/OTP (Linux/Android)
        if: ${{ matrix.target.platform == 'linux' || matrix.target.platform == 'android' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y erlang-dev erlang-base

      - name: Setup Erlang/OTP (macOS)
        if: ${{ matrix.target.platform == 'macos' }}
        run: |
          brew install erlang

      - name: Setup Erlang/OTP (Windows)
        if: ${{ matrix.target.platform == 'windows' }}
        shell: pwsh
        run: |
          choco install erlang -y

      # Build GDExtension
      - name: ðŸ”— GDExtension Build
        uses: godotengine/godot-cpp-template/.github/actions/build@f9564a9c8115139b9624692d39e358291f6d76ce
        with:
          platform: ${{ matrix.target.platform }}
          arch: ${{ matrix.target.arch }}
          gdextension-directory: .
          float-precision: ${{ matrix.float-precision }}
          build-target-type: ${{ matrix.target-type }}

      # Mac Sign (only for macOS on main branch)
      - name: Set macOS precision extension
        if: ${{ matrix.target.platform == 'macos' && github.ref == 'refs/heads/main' }}
        id: macos_ext
        run: |
          if [ "${{ matrix.float-precision }}" = "double" ]; then
            echo "extension=.double" >> $GITHUB_OUTPUT
          else
            echo "extension=" >> $GITHUB_OUTPUT
          fi

      - name: Mac Sign
        if: ${{ matrix.target.platform == 'macos' && github.ref == 'refs/heads/main' }}
        uses: godotengine/godot-cpp-template/.github/actions/sign@f9564a9c8115139b9624692d39e358291f6d76ce
        with:
          FRAMEWORK_PATH: bin/addons/godot_cnode/bin/libgodot_cnode.macos.${{ matrix.target-type }}${{ steps.macos_ext.outputs.extension }}.universal.framework
          SIGN_FLAGS: "--deep"
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          APPLE_DEV_PASSWORD: ${{ secrets.APPLE_DEV_PASSWORD }}
          APPLE_DEV_ID: ${{ secrets.APPLE_DEV_ID }}
          APPLE_DEV_TEAM_ID: ${{ secrets.APPLE_DEV_TEAM_ID }}
          APPLE_DEV_APP_ID: ${{ secrets.APPLE_DEV_APP_ID }}

      # Upload Artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Godot_CNode-${{ matrix.target.platform }}-${{ matrix.target.arch }}-${{ matrix.float-precision }}-${{ matrix.target-type }}
          path: |
            ${{ github.workspace }}/bin/**/*.so
            ${{ github.workspace }}/bin/**/*.dll
            ${{ github.workspace }}/bin/**/*.framework/**
            ${{ github.workspace }}/bin/addons/godot_cnode/**
          if-no-files-found: error

  build_full:
    needs: [lint]
    if: github.event_name != 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        target:
          [
            { platform: linux, arch: x86_64, os: ubuntu-latest },
            { platform: windows, arch: x86_64, os: windows-latest },
            { platform: windows, arch: x86_32, os: windows-latest },
            { platform: macos, arch: universal, os: macos-latest },
            { platform: android, arch: arm64, os: ubuntu-latest },
            { platform: android, arch: arm32, os: ubuntu-latest },
            { platform: android, arch: x86_64, os: ubuntu-latest },
            { platform: android, arch: x86_32, os: ubuntu-latest },
            { platform: ios, arch: arm64, os: macos-latest },
          ]
        target-type: [template_release]
        float-precision: [single, double]
    runs-on: ${{ matrix.target.os }}
    steps:
      # Clone this repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      # Setup Erlang/OTP for erl_interface (needed for godot-cnode)
      # Note: erl_interface is built from source, but we install Erlang for system libraries
      - name: Setup Erlang/OTP (Linux/Android)
        if: ${{ matrix.target.platform == 'linux' || matrix.target.platform == 'android' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y erlang-dev erlang-base

      - name: Setup Erlang/OTP (macOS/iOS)
        if: ${{ matrix.target.platform == 'macos' || matrix.target.platform == 'ios' }}
        run: |
          brew install erlang

      - name: Setup Erlang/OTP (Windows)
        if: ${{ matrix.target.platform == 'windows' }}
        shell: pwsh
        run: |
          choco install erlang -y

      # Build GDExtension
      - name: ðŸ”— GDExtension Build
        uses: godotengine/godot-cpp-template/.github/actions/build@f9564a9c8115139b9624692d39e358291f6d76ce
        with:
          platform: ${{ matrix.target.platform }}
          arch: ${{ matrix.target.arch }}
          gdextension-directory: .
          float-precision: ${{ matrix.float-precision }}
          build-target-type: ${{ matrix.target-type }}

      # Mac Sign (only for macOS on main branch)
      - name: Set macOS precision extension
        if: ${{ matrix.target.platform == 'macos' && github.ref == 'refs/heads/main' }}
        id: macos_ext
        run: |
          if [ "${{ matrix.float-precision }}" = "double" ]; then
            echo "extension=.double" >> $GITHUB_OUTPUT
          else
            echo "extension=" >> $GITHUB_OUTPUT
          fi

      - name: Mac Sign
        if: ${{ matrix.target.platform == 'macos' && github.ref == 'refs/heads/main' }}
        uses: godotengine/godot-cpp-template/.github/actions/sign@f9564a9c8115139b9624692d39e358291f6d76ce
        with:
          FRAMEWORK_PATH: bin/addons/godot_cnode/bin/libgodot_cnode.macos.${{ matrix.target-type }}${{ steps.macos_ext.outputs.extension }}.universal.framework
          SIGN_FLAGS: "--deep"
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          APPLE_DEV_PASSWORD: ${{ secrets.APPLE_DEV_PASSWORD }}
          APPLE_DEV_ID: ${{ secrets.APPLE_DEV_ID }}
          APPLE_DEV_TEAM_ID: ${{ secrets.APPLE_DEV_TEAM_ID }}
          APPLE_DEV_APP_ID: ${{ secrets.APPLE_DEV_APP_ID }}

      # Upload Artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Godot_CNode-${{ matrix.target.platform }}-${{ matrix.target.arch }}-${{ matrix.float-precision }}-${{ matrix.target-type }}
          path: |
            ${{ github.workspace }}/bin/**/*.so
            ${{ github.workspace }}/bin/**/*.dll
            ${{ github.workspace }}/bin/**/*.framework/**
            ${{ github.workspace }}/bin/addons/godot_cnode/**
          if-no-files-found: error

  # Merges all the build artifacts together into a single Godot_CNode artifact.
  merge:
    runs-on: ubuntu-latest
    needs: [build_ci, build_full]
    if: always()
    steps:
      - name: Merge Artifacts
        uses: actions/upload-artifact/merge@v4
        with:
          name: Godot_CNode
          pattern: Godot_CNode-*
          delete-merged: true

  test_integration:
    name: Test CNode Integration
    needs: [build_ci]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Erlang/OTP
        run: |
          sudo apt-get update
          sudo apt-get install -y erlang-dev erlang-base

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.16.0"
          otp-version: "26.2.2"

      - name: Download Godot
        run: |
          GODOT_VERSION="4.1.3"
          wget -q https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable/Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip
          unzip -q Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip
          chmod +x Godot_v${GODOT_VERSION}-stable_linux.x86_64
          sudo mv Godot_v${GODOT_VERSION}-stable_linux.x86_64 /usr/local/bin/godot
          godot --version

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: Godot_CNode-linux-x86_64-single-template_release
          path: bin/addons/godot_cnode

      - name: Verify GDExtension exists
        run: |
          ls -la bin/addons/godot_cnode/bin/ || echo "GDExtension not found"
          test -f bin/addons/godot_cnode/bin/libgodot_cnode.linux.template_release.x86_64.so || exit 1
          echo "âœ“ GDExtension found"

      - name: Run CNode integration tests
        run: |
          cd ${{ github.workspace }}
          export GODOT_BIN=godot
          chmod +x test/run_cnode_test.sh
          timeout 60 test/run_cnode_test.sh || exit 1

  release:
    name: Create Release
    permissions:
      contents: write
    needs: [merge]
    uses: ./.github/workflows/release.yml


